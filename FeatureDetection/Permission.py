'''
Created on 2014-3-11

@author: sumy

@warning: This model is depend on androguard.
'''

import os
import sys
import hashlib
import io

sys.path.append("/home/sumy/androguard-1.9")

from androguard.core.bytecodes import apk

srcpath = ""
tarpath = ""

def getfilemd5(filepath):
    m = hashlib.md5()
    file = io.FileIO(filepath, "r")
    bytes = file.read(1024)
    while(bytes != b''):
        m.update(bytes)
        bytes = file.read(1024)
    file.close()
    
    md5value = m.hexdigest()
    return md5value
    

def writetofile(tarpath, md5, permissions):
    print "Saving..."
    filepath = tarpath + md5 + ".txt"
    if(os.path.exists(filepath)):
        print filepath , "is exist. Rewrite!!!"
    file = io.FileIO(filepath, "w")
    for permiss in permissions:
        file.write(permiss + "\n")
    file.close()
    print "Done!"

def getapkpermissions(apkpath):
    try:
        a = apk.APK(apkpath)
    except Exception, e:
        pass
    else:
        if(a.is_valid_APK()):
            permission = a.get_permissions()
            return permission
        else:
            print apkpath , " is not a apk."
            return None
    
def main(srcpath, tarpath):
    filelist = []
    if(tarpath[-1] != "/"):
        tarpath = tarpath + "/"
    if(os.path.isfile(srcpath)):
        filelist.append(srcpath)
    elif(os.path.isdir(srcpath)):
        if(srcpath[-1] != "/"):
            srcpath = srcpath + "/"
        filelist = [(srcpath + x) for x in os.listdir(srcpath)]
    else:
        print "ooops, please check src path."
    for path in filelist:
        permissions = getapkpermissions(path)
        if(permissions != None):
            permissions = sorted(permissions)
            md5 = getfilemd5(path)
            print "The apk md5:" , md5
            print permissions
            writetofile(tarpath, md5 , permissions)

if __name__ == '__main__':
    if(len(sys.argv) == 1):
        print "None apk to get info."
        sys.exit(0)
    elif(len(sys.argv) == 2):
        srcpath = sys.argv[1]
        tarpath = os.getcwd()
    else:
        srcpath = sys.argv[1]
        tarpath = sys.argv[2]
        if(os.path.isdir(tarpath) == False):
            print tarpath , " is unavailable path."
            sys.exit(0)
    print "The apk from:" , srcpath
    print "The result to:" , tarpath
    main(srcpath, tarpath)
    
