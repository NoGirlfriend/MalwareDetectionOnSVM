'''
Created on 2014-3-11

@author: sumy

@warning: This model is depend on androguard.
'''

import os
import sys
import hashlib
import io

sys.path.append("/home/sumy/androguard-1.9")

from androguard.core.bytecodes import apk

srcpath = ""
tarpath = ""
filelist = []

def getfilemd5(filepath):
    m = hashlib.md5()
    file = io.FileIO(filepath, "r")
    bytes = file.read(1024)
    while(bytes != b''):
        m.update(bytes)
        bytes = file.read(1024)
    file.close()
    
    md5value = m.hexdigest()
    return md5value
    

def writetofile(tarpath, md5, packagename, permissions):
    print "============================="
    print "Saving..."
    filepath = tarpath + md5 + ".txt"
    if(os.path.exists(filepath)):
        print filepath , "is exist. Rewrite!!!"
    file = io.FileIO(filepath, "w")
    file.write(packagename + "\n")
    for permiss in permissions:
        file.write(permiss + "\n")
    file.close()
    print "Done!"
    print "============================="

def getapkinformation(apkpath):
    try:
        a = apk.APK(apkpath)
    except Exception, e:
        pass
    else:
        if(a.is_valid_APK()):
            information = [ a.get_package() ]
            information = information + a.get_permissions()
            return information
        else:
            print apkpath , " is not a apk."
            return None
    
def dfspath(srcpath):
    if(srcpath[-1] != "/"):
        srcpath = srcpath + "/"
    for x in os.listdir(srcpath) :
        nowpath = srcpath + x
        if os.path.isdir(nowpath) :
            dfspath(nowpath)
        elif os.path.isfile(nowpath) :
            filelist.append(nowpath)

def processing(tarpath):
    if tarpath[-1] != "/" :
        tarpath = tarpath + "/"
    for path in filelist:
        information = getapkinformation(path)
        if information != None :
            packagename = information[0]
            permissions = information[1:]
            permissions = sorted(permissions)
            md5 = getfilemd5(path)
            print "The packagename: ", packagename
            print "The apk md5:" , md5
            print permissions
            writetofile(tarpath, md5, packagename, permissions)

if __name__ == '__main__':
    if(len(sys.argv) == 1):
        print "None apk to get info."
        sys.exit(0)
    elif(len(sys.argv) == 2):
        srcpath = sys.argv[1]
        tarpath = os.getcwd() + "/permission"
        if not os.path.exists(tarpath) :
            os.makedirs(tarpath)
    else:
        srcpath = sys.argv[1]
        tarpath = sys.argv[2]
        if(os.path.isdir(tarpath) == False):
            print tarpath , " is unavailable path."
            sys.exit(0)
    print "The apk from:" , srcpath
    print "The result to:" , tarpath
    dfspath(srcpath)
    processing(tarpath)
    print "OVER! Processed", len(filelist), "file(s)."

    
